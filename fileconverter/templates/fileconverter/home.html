<!DOCTYPE html>
<html lang="en">
{% load static %}

<head>
    <meta charset="UTF-8">
    <title>움짤 생성기</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'CSS/style.css' %}" media="screen">
    <script src='https://unpkg.com/vue/dist/vue.min.js'></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
</head>

<body>
    <div id="app" class="container" v-cloak>
        <div class="panel panel-default">
            <div class="panel-heading"><b>Make GIF</b></div>
            <div class="panel-body">
                <h3>움짤 생성기</h3>
                <div class="container empty" :class="{ ' hovered' : isHoverTrue }" 
                @dragleave.prevent="onDragLeave" @dragover.prevent="onDragOver" @drop.prevent="onDrop">
                    <div v-if="isHoverTrue == false" class="row">
                        <div class="col-sm center-block text-center height">        
                        </div>
                        <div class="col-sm center-block text-center height pt-5">
                            <input class="file inputfile" type="file" id="image_uploads" multiple
                                @change="add_files">
                            <label for="image_uploads"><strong id="searchfile">파일 찾기 </strong> 
                                <span>또는 박스에 파일 끌어다 놓기</span>
                            </label>
                        </div>
                        <div class="col-sm center-block text-center height">        
                        </div>
                    </div>
                </div>
                <br>
                <input class="form-control" :class="{' disappear' : isSelectTrue}" type="text" v-model="inputURL" placeholder="동영상 URL입력">
                <br>
                <ol class="fileNames" style="list-style: none; padding-left:0px;">
                    <li v-for="(namecheck, index) in fileNamesWithCheck">
                        <div v-if="namecheck.fileName != 'default'" class="p-3 mb-2 bg-light text-dark">
                            <span>[[ namecheck.fileName ]]</span>
                            <button type="button" class="close" aria-label="Close">
                                <span v-if="namecheck.fileUploaded">upload완료</span>
                                <span v-else aria-hidden="true" v-on:click="remove_todo(index)">&times;</span>
                            </button>
                        </div>
                    </li>
                    <li v-if="fileSizeCheck">
                        <p>총 파일 크기: [[ returnedFileSize(fileSize) ]]</p>
                    </li>
                </ol>
                <div v-for="(converted, index) in forConvertButton" class="buttons">
                    <button v-if="converted.checkConverted" type="submit" class="btn btn-success">움짤 만들기</button>
                    <button v-else type="submit" class="btn btn-success" v-on:click="uploadFiles()">업로드</button>
                </div>
            </div>
        </div>
    </div>


    <!-- <script src='https://unpkg.com/vue/dist/vue.min.js'></script> -->
    <!-- <script src="https://unpkg.com/axios/dist/axios.min.js"></script> -->
    <script>
        axios.defaults.xsrfCookieName = 'csrftoken';
        axios.defaults.xsrfHeaderName = 'x-CSRFToken';
        var input = document.querySelector('input');
        input.style.opacity = 0;

        var vm = new Vue({
            delimiters: ['[[', ']]'],
            el: '#app',
            data: {
                limitSize: 52428800,
                isHoverTrue: false,
                isSelectTrue: false,
                file: '',
                fileSize: 0,
                fileList: [],
                fileNamesWithCheck: [
                ],
                forConvertButton: [
                    {
                        checkConverted: false,
                    }
                ],
                fileSizeCheck: false,
                inputURL: '',
                fileTypes: [
                    'video/avi',
                    'video/flv',
                    'video/wmv',
                    'video/mov',
                    'video/mp4'
                ],
                fileEndTypes: [
                    'avi',
                    'flv',
                    'wmv',
                    'mov',
                    'mp4',
                    'webm',
                ]

            },
            methods: {
                verifyURL: function (checkURL) {
                    console.log("verifyURL");
                    var url = checkURL;
                    var pattern = /(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%@!\-\/]))?/;
                    var fileExtend = this.verifyExtends(url);
                    console.log(fileExtend);
                    if (pattern.test(url) && fileExtend) {
                        return true;
                    } else {
                        return false;
                    }
                },

                verifyExtends: function(url) {
                    var fileExtends = url.split(/\#|\?/)[0].split('.').pop().trim();
                    console.log(fileExtends)
                    if (this.fileEndTypes.includes(fileExtends)){
                        return true;
                    }
                    else {
                        return false;
                    }
                },

                uploadFiles: function () {
                    var vm = this;
                    var verifiedURL;

                    if (vm.inputURL !== '') {
                        verifiedURL = this.verifyURL(this.inputURL);
                        if (verifiedURL === false) {
                            alert("Url형식이 아닙니다");
                            return;
                        }
                        this.isHoverTrue = true;
                    }

                    if (vm.fileList.length === 0 && verifiedURL !== true) {
                        alert("파일을 추가해 주세요")
                        return;
                    }


                    // 파일을 base64형태로 바꾸는 작업 
                    // for (var i = 0; i < vm.fileList.length; i++) {
                    //     var file = vm.fileList[i]

                    //     function getBase(file, callback) {
                    //         var reader = new FileReader();
                    //         reader.onload = function (file) {
                    //             var result = file.target.result;
                    //             console.log(result);
                    //             callback(result);
                    //         }
                    //         reader.readAsDataURL(file);
                    //     }
                    //     // FileReader형식이 비동기이기 때문에 콜백함수 사용
                    //     getBase(file, function(result){
                    //         vm.fileURLList[i] = result;
                    //         console.log(vm.fileURLList[i]);
                    //     })
                    // }

                    var form = new FormData();
                    if (vm.fileList.length !== 0) {
                        for (var i = 0; i < vm.fileList.length; i++) {
                            form.append('uploadedFiles', vm.fileList[i]);
                            console.log(vm.fileList[i]);
                            // form.append('fileNames', vm.fileNames[i]);
                        }
                        axios.post('/convert/upload/', form)
                            .then(function (res) {
                                console.log("POST RES", res);
                                for (var i = 0; i < vm.fileList.length; i++) {
                                    vm.fileNamesWithCheck[i].fileUploaded = true;
                                    console.log(vm.fileNamesWithCheck[i].fileUploaded);
                                }
                                vm.forConvertButton[0].checkConverted = true;
                                vm.fileSizeCheck[0].fileSize = false;
                            })
                            .catch(function (err) {
                                console.log("GET ERR", err);
                            })
                    } else {
                        var sendURL = {uploadURL: this.inputURL};
                        console.log(vm.inputURL);

                        axios.post('/convert/urlupload/', sendURL)
                            .then(function (res) {
                                console.log("POST RES", res);
                                // push하는 이유는 vue v-if를 조정시키기 위해서이다.
                                vm.fileNamesWithCheck.push({
                                fileName: res.data.fileName,
                                fileUploaded: true,
                            });
                            vm.forConvertButton[0].checkConverted = true;
                            vm.fileSizeCheck = false
                            })
                            .catch(function (err) {
                                console.log("GET ERR", err);
                            })
                    }
                },
                add_files: function (event) {
                    console.log(event.target.files);
                    files = event.target.files;

                    this.addFileSize(files);

                    for (file of files) {
                        console.log(typeof (file.type));
                        console.log(file.type);
                        if (!this.validFileType(file.type)) {
                            alert("변환할 수 있는 파일이 아닙니다");
                            this.minusFileSize(files);
                            return;
                        }
                    }

                    var fileCountLimit = this.fileList.length + files.length;

                    if (fileCountLimit > 2) {
                        alert("파일 최대 2개까지 선택가능");
                        this.minusFileSize(files);
                        return;
                    } else if (this.fileSize > this.limitSize) {
                        alert("파일 총 크기 제한 50MB");
                        // for(file of files){
                        //     this.fileSize = this.fileSize - file.size;
                        // }
                        console.log(this.fileSize);
                        console.log(typeof (files));
                        this.minusFileSize(files);
                        return;
                    }

                    for (file of files) {
                        this.fileList.push(file);
                        this.fileNamesWithCheck.push({
                            fileName: file.name,
                            fileUploaded: false,
                        });
                    }
                    this.fileSizeCheck = true;
                    this.isSelectTrue = true;
                },

                returnedFileSize: function (number) {
                    if (number < 1024) {
                        return number + 'bytes';
                    } else if (number >= 1024 && number < 1048576) {
                        return (number / 1024).toFixed(1) + 'KB';
                    } else if (number >= 1048576) {
                        return (number / 1048576).toFixed(1) + 'MB';
                    }
                },

                // remove_all() {
                //     console.log(this.fileList.length);

                //     this.fileList.splice(0, this.fileList.length);
                //     this.fileNames.splice(0, this.fileNames.length);
                //     this.fileSize = 0;
                // },
                remove_todo: function (index) {
                    console.log(index);
                    console.log(this.fileList[index].size);
                    this.fileSize -= this.fileList[index].size;
                    this.fileList.splice(index, 1);
                    this.fileNamesWithCheck.splice(index, 1);
                    if (this.fileList.length == 0){
                        this.isSelectTrue= false;      
                        this.fileSizeCheck= false;
                    }
                },
                onDrop: function (event) {
                    if(vm.fileNamesWithCheck.length !== 0){      
                        return;
                    }

                    console.log("ondrop");
                    // event.stopPropagation();
                    // event.preventDefault();

                    console.log('dragEnter');
                    this.className += ' hovered';

                    var files = event.dataTransfer.files;

                    this.addFileSize(files);
                    console.log(this.fileSize);

                    for (file of files) {
                        console.log(typeof (file.type));
                        console.log(file.type);
                        if (!this.validFileType(file.type)) {
                            alert("변환할 수 있는 파일이 아닙니다");
                            this.minusFileSize(files);
                            return;
                        }
                    }

                    var fileCountLimit = this.fileList.length + files.length;
                    if (fileCountLimit > 2) {
                        alert("파일 최대 2개까지 선택가능");
                        this.minusFileSize(files);
                        this.isHoverTrue = false;
                        return;
                    } else if (this.fileSize > this.limitSize) {
                        alert("파일 총 크기 제한 50MB");

                        console.log(this.fileSize);
                        console.log(typeof (files));
                        this.minusFileSize(files);
                        this.isHoverTrue = false;
                        return;
                    }

                    for (file of files) {
                        this.fileList.push(file);
                        this.fileNamesWithCheck.push({
                            fileName: file.name,
                            fileUploaded: false,
                        });
                    }
                    this.fileSizeCheck = true;
                    this.isSelectTrue = true;
                    this.isHoverTrue = false;
                },

                onDragOver: function (event) {
                    // event.stopPropagation();
                    // event.preventDefault();

                    console.log('dragOver');
                    this.isHoverTrue = true;
                },

                onDragLeave: function (event) {
                    // event.stopPropagation();
                    // event.preventDefault();

                    console.log('dragLeave');
                    this.isHoverTrue = false;
                },

                validFileType: function (fileType) {
                    console.log(this.fileTypes.includes(fileType));
                    return this.fileTypes.includes(fileType);
                },

                addFileSize: function (files) {
                    for (file of files) {
                        this.fileSize += file.size;
                        console.log(this.fileSize);
                    }
                },

                minusFileSize: function (files) {
                    console.log(file.size);
                    console.log(this.fileSize);

                    for (file of files) {
                        this.fileSize = this.fileSize - file.size;
                    }

                    console.log(this.fileSize);
                }
            },
        });

    </script>
    <!-- <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script> -->

</body>

</html>